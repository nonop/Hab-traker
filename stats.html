<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Routine — Stats</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111111">
<style>
:root{--bg:#0f1115;--card:#151821;--text:#e8eaf0;--muted:#9aa3b2;--accent:#48c78e}
*{box-sizing:border-box} a,button{color:inherit}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
header{position:sticky;top:0;padding:12px 16px;padding-top:calc(12px + env(safe-area-inset-top));display:flex;gap:8px;align-items:center;backdrop-filter:saturate(140%) blur(6px);background:linear-gradient(rgba(0,0,0,.18),rgba(0,0,0,.02))}
.container{padding:14px 16px 40px}
.card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}
.pill.active{background:var(--accent);color:#06140d;border-color:transparent}
.small{font-size:12px;color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cell{height:22px;border-radius:4px;background:#2b2f36}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,.06);padding:8px}
</style>
</head>
<body>
<header>
  <a href="index.html" class="pill">← Suivi</a>
  <div style="margin-left:auto" class="small" id="summary"></div>
</header>

<main class="container">
  <div class="card">
    <div class="row">
      <button class="pill active" data-v="week">Semaine</button>
      <button class="pill" data-v="month">Mois</button>
      <button class="pill" data-v="quarter">3 mois</button>
      <button class="pill" data-v="year">Année</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div><strong>Heatmap</strong> <span class="small">(taux de réussite par jour)</span></div>
    </div>
    <div id="heat" class="grid"></div>
    <div class="small" style="margin-top:6px">Plus c’est vert, plus la journée est réussie.</div>
  </div>

  <div class="card">
    <div><strong>Top habitudes</strong></div>
    <table class="table" id="top"><thead><tr><th>Habitude</th><th>%</th></tr></thead><tbody></tbody></table>
  </div>
</main>

<script>
const DBK="habapp.v6"; const $=s=>document.querySelector(s);
let state = JSON.parse(localStorage.getItem(DBK)||'{"version":6,"habits":[],"logs":{},"settings":{}}');

function iso(d){ const x=new Date(d); x.setMinutes(x.getMinutes()-x.getTimezoneOffset()); return x.toISOString().slice(0,10); }
function daysBack(n){ const out=[]; for(let i=n-1;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); out.push(new Date(d)); } return out; }
function dueOn(h,d){ if(h.type==='daily'||h.type==='life') return true; if(h.type==='weekly') return (h.weekdays||[]).includes(d.getDay()); return true; }

function render(period='week'){
  const ranges={week:7,month:30,quarter:90,year:365};
  const n=ranges[period]||7;
  const days=daysBack(n);
  const active=state.habits.filter(h=>!h.archived);
  const logs=state.logs||{};

  let totalDue=0,totalDone=0;
  days.forEach(d=>{
    const k=iso(d);
    active.forEach(h=>{
      if(!dueOn(h,d)) return;
      totalDue++;
      const val=(logs[h.id]&&logs[h.id][k])||0;
      const target = (h.objective && h.objective.mode==='perday') ? (h.objective.value||1) : 1;
      if(val>=target) totalDone++;
    });
  });
  const rate = totalDue? Math.round(totalDone/totalDue*100):0;
  $("#summary").textContent=`${rate}% sur ${period}`;

  const grid=$("#heat"); grid.innerHTML='';
  days.forEach(d=>{
    const k=iso(d);
    let due=0,done=0;
    active.forEach(h=>{
      if(!dueOn(h,d)) return;
      due++;
      const val=(logs[h.id]&&logs[h.id][k])||0;
      const target = (h.objective && h.objective.mode==='perday') ? (h.objective.value||1) : 1;
      if(val>=target) done++;
    });
    const r = due? Math.round(done/due*100):0;
    const c = r>75? '#2fbb88' : r>40 ? '#6ecfa0' : '#2b2f36';
    const div=document.createElement('div'); div.className='cell'; div.style.background=c; div.title=`${k} — ${done}/${due} (${r}%)`;
    grid.appendChild(div);
  });

  const arr = active.map(h=>{
    let due=0,done=0;
    days.forEach(d=>{
      if(!dueOn(h,d)) return;
      due++;
      const val=(logs[h.id]&&logs[h.id][iso(d)])||0;
      const target = (h.objective && h.objective.mode==='perday') ? (h.objective.value||1) : 1;
      if(val>=target) done++;
    });
    return {name:h.name, rate: due? Math.round(done/due*100):0};
  }).sort((a,b)=>b.rate-a.rate).slice(0,5);
  const tb=$("#top tbody"); tb.innerHTML=''; arr.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.name}</td><td>${x.rate}%</td>`; tb.appendChild(tr); });
}

document.querySelectorAll('[data-v]').forEach(b=>{
  b.onclick=()=>{ document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); b.classList.add('active'); render(b.dataset.v); };
});
render('week');
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
</script>
</body>
</html>
