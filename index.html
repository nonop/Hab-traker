<!doctype html><html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Habitudes</title><link rel="manifest" href="manifest.webmanifest"><meta name="theme-color" content="#111">
<style>
:root{--bg:#0f1115;--card:#171a21;--ink:#e8eaf0;--mut:#9aa3b2;--acc:#48c78e;--grid:#20242e;--ok:#173d2e;--ok2:#1ea874}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial}
header,footer{position:sticky;z-index:10;background:linear-gradient(0deg,transparent,rgba(0,0,0,.35))}
header{top:0;padding:.8rem 1rem;display:flex;gap:.5rem;align-items:center;justify-content:space-between}
footer{bottom:0;padding:.6rem 1rem;display:flex;gap:.5rem;justify-content:space-between}
.btn{background:var(--acc);color:#08130e;border:0;border-radius:10px;padding:.55rem .9rem;font-weight:600}
.btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--grid)}
.wrap{padding:1rem;display:flex;flex-direction:column;gap:1rem}
.card{background:var(--card);border:1px solid var(--grid);border-radius:12px;padding:.9rem}
.hsec{margin-top:.4rem}.hsec>summary{list-style:none;cursor:pointer;font-weight:700}
.hsec>summary::-webkit-details-marker{display:none}
.item{display:flex;justify-content:space-between;align-items:center;border-top:1px dashed var(--grid);padding:.65rem .2rem}
.name{font-weight:600}.sub{font-size:.85rem;color:var(--mut)}
.check{width:26px;height:26px;border:2px solid #3a4150;border-radius:8px;background:#0c0f15}
.done{background:linear-gradient(180deg,#59dcac,#21b37f);border-color:var(--ok2);position:relative}
.done:after{content:"";position:absolute;left:7px;top:3px;width:7px;height:14px;border:3px solid #0b2c20;border-left:0;border-top:0;transform:rotate(45deg)}
.row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}.mut{color:var(--mut);font-size:.9rem}
.badge{border:1px solid var(--grid);border-radius:999px;padding:.05rem .45rem;font-size:.75rem;color:var(--mut)}
.okline{background:var(--ok);border-radius:10px;padding:.35rem .5rem}
.search{background:#0c0e13;border:1px solid var(--grid);color:var(--ink);border-radius:10px;padding:.55rem .7rem;flex:1}
</style></head><body>
<header>
  <div class="row">
    <a href="settings.html" style="text-decoration:none"><button class="btn ghost">Gestion</button></a>
    <a href="stats.html" style="text-decoration:none"><button class="btn ghost">Stats</button></a>
  </div>
  <div class="row">
    <input id="q" class="search" placeholder="Rechercher…">
    <button id="due" class="btn ghost">Due aujourd’hui</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row"><span class="mut">Aujourd’hui :</span><span id="today" class="badge"></span></div>
    <div class="row"><span id="kpi" class="badge">0 fait / 0 dû</span></div>
  </div>

  <div class="card">
    <details class="hsec" open><summary>Matin</summary><div id="list-morning"></div></details>
    <details class="hsec" open><summary>Journée</summary><div id="list-day"></div></details>
    <details class="hsec" open><summary>Soir</summary><div id="list-evening"></div></details>
    <details class="hsec" open><summary>Hebdo du jour</summary><div id="list-weekly"></div></details>
    <details class="hsec" open><summary>Habitudes de vie</summary><div id="list-life"></div></details>
  </div>
  <div class="mut">Astuce : appui long → Archiver / Supprimer.</div>
</div>

<footer>
  <button id="export" class="btn ghost">Exporter</button>
  <input type="file" id="import" accept="application/json" style="display:none">
  <button id="importBtn" class="btn ghost">Importer</button>
  <button id="install" class="btn" style="display:none">Installer</button>
</footer>

<script>
/* ========== Storage & modèle ========== */
const DBK="habapp.v3";
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const db={load(){try{return JSON.parse(localStorage.getItem(DBK))||{version:3,habits:[],logs:{},settings:{}}}catch{return{version:3,habits:[],logs:{},settings:{}}}},save(x){localStorage.setItem(DBK,JSON.stringify(x))}};
let state=db.load();
/* habit = {id,name,type:'daily'|'weekly'|'lifestyle',slot:'morning'|'day'|'evening'|null,weekdays:[0..6],required:boolean,goal:{d:1,w:1,m:0},archived:boolean,created_at} */

const today = new Date(); const tzfix = d=>new Date(d.getTime()-d.getTimezoneOffset()*60000);
const todayISO = tzfix(today).toISOString().slice(0,10);
const wd = today.getDay(); // 0=Dim..6=Sam
$("#today").textContent = today.toLocaleDateString('fr-CH',{weekday:'long',day:'2-digit',month:'long'});

/* ========== Due logic ========== */
const isDue = (h) => {
  if(h.archived) return false;
  if(h.type==='daily') return true;
  if(h.type==='weekly') return (h.weekdays||[]).includes(wd);
  if(h.type==='lifestyle') return true;
  return true;
};

/* ========== Render ========== */
function render(){
  const q = $("#q").value.trim().toLowerCase();
  const dueOnly = $("#due").classList.contains("on");

  const lists = {
    morning: $("#list-morning"), day: $("#list-day"), evening: $("#list-evening"),
    weekly: $("#list-weekly"), life: $("#list-life")
  };
  Object.values(lists).forEach(el=>el.innerHTML="");

  const logs = state.logs||{};
  let dueCount=0, doneCount=0;

  state.habits.filter(h=>!h.archived).forEach(h=>{
    if(q && !h.name.toLowerCase().includes(q)) return;
    const due = isDue(h);
    if(dueOnly && !due) return;

    const done = !!(logs[h.id] && logs[h.id][todayISO]);
    if(due) { dueCount++; if(done) doneCount++; }

    const div=document.createElement("div"); div.className="item"+(done?" okline":"");
    div.innerHTML = `
      <div>
        <div class="name">${h.name}</div>
        <div class="sub">
          <span class="badge">${h.type}</span>
          ${h.type==='daily' && h.slot? `<span class="badge">${h.slot}</span>`:""}
          ${h.type==='weekly'? `<span class="badge">jours:${(h.weekdays||[]).map(i=>["D","L","Ma","Me","J","V","S"][i]).join("")||"-"}</span>`:""}
          ${h.required? `<span class="badge">indispensable</span>`:""}
        </div>
      </div>
      <div class="check ${done?'done':''}" data-h="${h.id}"></div>
    `;
    // appui long → menu
    let t=null;
    div.addEventListener("touchstart",()=>{ t=setTimeout(()=>{ menu(h); },600); });
    div.addEventListener("touchend",()=>{ clearTimeout(t); });
    // click sur la check
    div.querySelector(".check").onclick = (e)=>{ toggle(h.id,todayISO); };
    // dispatch dans la bonne section
    if(h.type==='daily'){
      lists[h.slot||'day'].appendChild(div);
    }else if(h.type==='weekly'){
      lists.weekly.appendChild(div);
    }else{
      lists.life.appendChild(div);
    }
  });

  $("#kpi").textContent = `${doneCount} fait / ${dueCount} dû`;
}
function toggle(hid, iso){
  state.logs[hid]=state.logs[hid]||{};
  state.logs[hid][iso] = state.logs[hid][iso]?0:1;
  if(state.logs[hid][iso]===0) delete state.logs[hid][iso];
  db.save(state); render();
}
function menu(h){
  const act = prompt("Action: archive / delete / cancel","archive");
  if(!act) return;
  if(act.toLowerCase()==='archive'){ h.archived=true; db.save(state); render(); }
  else if(act.toLowerCase()==='delete'){
    if(confirm("Supprimer définitivement ? Historique perdu.")){
      state.habits = state.habits.filter(x=>x.id!==h.id);
      delete state.logs[h.id]; db.save(state); render();
    }
  }
}

/* ========== Import/Export/PWA ========== */
$("#export").onclick=()=>{
  const blob=new Blob([JSON.stringify(state)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="habits-backup.json"; a.click(); URL.revokeObjectURL(a.href);
};
$("#importBtn").onclick=()=>$("#import").click();
$("#import").onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ try{
    const data=JSON.parse(r.result);
    if(!data.habits||!data.logs) throw 0;
    state=data; db.save(state); render();
  }catch{ alert("Fichier invalide"); } };
  r.readAsText(f);
};
let deferred=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferred=e;$("#install").style.display="inline-block";});
$("#install").onclick=async()=>{ if(!deferred) return; deferred.prompt(); await deferred.userChoice; $("#install").style.display="none"; };
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }

/* ========== UI events ========== */
$("#q").oninput=render;
$("#due").onclick=()=>{ $("#due").classList.toggle("on"); $("#due").classList.toggle("btn"); $("#due").classList.toggle("ghost"); render(); };

/* ========== Init (seed si vide) ========== */
if(!state.habits || state.habits.length===0){
  const now=Date.now();
  state.habits=[
    {id:String(now+1),name:"Eau 500ml",type:"daily",slot:"morning",weekdays:[],required:true,goal:{d:1,w:0,m:0},archived:false,created_at:todayISO},
    {id:String(now+2),name:"Course 20 min",type:"weekly",slot:null,weekdays:[1,3,5],required:false,goal:{d:0,w:3,m:0},archived:false,created_at:todayISO},
    {id:String(now+3),name:"Alimentation 1800 kcal",type:"lifestyle",slot:null,weekdays:[],required:true,goal:{d:1},archived:false,created_at:todayISO}
  ];
  db.save(state);
}
render();
</script>
</body></html>
