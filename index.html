<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>Habits ‚Äî Suivi</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111111">
<style>
:root{
  --bg:#0f1115; --card:#151821; --text:#e8eaf0; --muted:#9aa3b2;
  --accent:#48c78e; --danger:#ff6b6b; --glass:rgba(255,255,255,0.06);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
header{position:sticky;top:0;padding:12px 16px;padding-top:calc(12px + env(safe-area-inset-top));display:flex;gap:8px;align-items:center;backdrop-filter:saturate(140%) blur(6px);background:linear-gradient(rgba(0,0,0,.18),rgba(0,0,0,.02))}
.brand{font-weight:800;font-size:18px}
.topbar{margin-left:auto;display:flex;gap:8px}
.iconbtn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:9px 10px;border-radius:12px;color:inherit}
.container{padding:14px 16px 100px}
.searchbar{display:flex;gap:8px}
.search{flex:1;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:#0c0f13;color:inherit}
.progressbox{margin:10px 0 6px}
.progressbar{height:10px;background:var(--glass);border-radius:999px;overflow:hidden}
.progress{height:100%;background:linear-gradient(90deg,var(--accent),#2bbf7b);width:0%}
.progressmeta{font-size:12px;color:var(--muted);margin-top:6px}
.section{margin-top:14px}
.card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:10px 8px}
.section-title{display:flex;align-items:center;gap:8px;font-weight:800;margin:2px 6px 6px}
.habit{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px;border-radius:12px}
.habit + .habit{margin-top:8px}
.h-left{display:flex;gap:10px;align-items:center;min-width:0}
.dot{width:12px;height:12px;border-radius:6px;flex:0 0 12px;border:2px solid rgba(0,0,0,.2)}
.h-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.h-meta{font-size:12px;color:var(--muted)}
.check{display:flex;gap:6px;align-items:center}
.btnpill{min-width:42px;height:42px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:transparent;color:inherit;font-weight:700}
.btnpill.done{background:linear-gradient(180deg,#59dcac,#21b37f);color:#052616;border:0}
.qty{display:flex;align-items:center;gap:6px;font-variant-numeric:tabular-nums}
.qty button{width:36px;height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:transparent;color:inherit}
.badge{border:1px solid rgba(255,255,255,.08);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
.fab{position:fixed;right:18px;bottom:calc(18px + env(safe-area-inset-bottom));background:var(--accent);color:#06140d;padding:14px 16px;border-radius:16px;border:0;font-weight:800;box-shadow:0 10px 28px rgba(0,0,0,.45)}
.modal{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);transition:transform .25s ease; background:var(--card);border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid rgba(255,255,255,.08);padding:14px 16px 18px}
.modal.show{transform:translateY(0)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input,select{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0c0f13;color:inherit}
.input.wide{flex:1}
.palette{display:flex;gap:8px;overflow:auto;padding-bottom:4px}
.swatch{width:32px;height:32px;border-radius:10px;border:2px solid rgba(0,0,0,.25)}
.help{font-size:12px;color:var(--muted)}
.toggle{display:flex;gap:8px}
.toggle button{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:transparent;color:inherit}
.toggle .active{background:var(--glass)}
.light{--bg:#f7f8fb;--card:#ffffff;--text:#0b0f12;--muted:#6b7280;--glass:rgba(0,0,0,.06)}
a,button{color:inherit}
.hidden{display:none}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="brand">Habits</div>
  <div class="topbar">
    <button id="themeBtn" class="iconbtn" title="Th√®me">üåì</button>
    <a href="stats.html" class="iconbtn" title="Stats">üìä</a>
  </div>
</header>

<main class="container">
  <!-- recherche + due -->
  <div class="searchbar">
    <input id="search" class="search" placeholder="Rechercher‚Ä¶">
    <button id="dueBtn" class="iconbtn" title="Due aujourd‚Äôhui">Due</button>
  </div>

  <!-- progression globale -->
  <div class="progressbox">
    <div class="progressbar"><div id="progress" class="progress"></div></div>
    <div id="progressMeta" class="progressmeta">0/0 faits (0%)</div>
  </div>

  <!-- sections -->
  <div id="sections" class="section"></div>
</main>

<!-- FAB cr√©ation -->
<button id="fab" class="fab">Ôºã</button>

<!-- modal ajout/√©dit rapide -->
<div id="sheet" class="modal" aria-modal="true" role="dialog">
  <div class="row">
    <input id="hName" class="input wide" placeholder="Nom de l‚Äôhabitude (ex. Boire 1L)">
  </div>

  <div class="row" style="margin-top:8px">
    <div class="toggle" style="width:100%">
      <button data-type="daily" class="active">Quotidienne</button>
      <button data-type="weekly">Hebdo</button>
      <button data-type="life">Vie</button>
    </div>
  </div>

  <div id="slotRow" class="row" style="margin-top:8px">
    <div class="toggle" style="width:100%">
      <button data-slot="morning" class="active">üåÖ Matin</button>
      <button data-slot="day">üåû Journ√©e</button>
      <button data-slot="evening">üåô Soir</button>
    </div>
  </div>

  <div id="weekRow" class="row hidden" style="margin-top:4px">
    <label><input type="checkbox" data-d="1">L</label>
    <label><input type="checkbox" data-d="2">Ma</label>
    <label><input type="checkbox" data-d="3">Me</label>
    <label><input type="checkbox" data-d="4">J</label>
    <label><input type="checkbox" data-d="5">V</label>
    <label><input type="checkbox" data-d="6">S</label>
    <label><input type="checkbox" data-d="0">D</label>
  </div>

  <div class="row" style="margin-top:8px">
    <label class="small">Objectif / Quantit√© :</label>
    <select id="objMode" class="input">
      <option value="perday">x/jour</option>
      <option value="perweek">x/semaine</option>
      <option value="permonth">x/mois</option>
    </select>
    <input id="objVal" type="number" class="input" value="1" min="1" style="width:90px">
  </div>

  <div class="row" style="margin-top:8px">
    <span class="small">Couleur</span>
    <div id="palette" class="palette"></div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="save" class="iconbtn" style="background:var(--accent);color:#06140d;border:0">Ajouter</button>
    <button id="cancel" class="iconbtn">Annuler</button>
  </div>
  <div class="help" style="margin-top:6px">Astuce : pour une habitude ‚Äúmulti-fois par jour‚Äù, mets un objectif &gt; 1 (ex. 3 verres d‚Äôeau).</div>
</div>

<script>
/* ====== State ====== */
const DBK="habapp.v5";
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
let state = JSON.parse(localStorage.getItem(DBK)||'{"version":5,"habits":[],"logs":{},"settings":{"theme":"auto","accent":"#48c78e"}}');

function save(){ localStorage.setItem(DBK, JSON.stringify(state)); }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }

const COLORS=['#48c78e','#2E86AB','#E27D60','#F6C85F','#9AD3BC','#A9A9F5','#FFA7C4','#8DD3C7','#7FB069','#B39CD0','#FFB347'];

/* theme */
function applyTheme(){
  const th = state.settings.theme||'auto';
  if(th==='auto'){
    const dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.classList.toggle('light', !dark);
  } else {
    document.documentElement.classList.toggle('light', th==='light');
  }
  document.documentElement.style.setProperty('--accent', state.settings.accent||'#48c78e');
}
applyTheme();

/* seed */
const today = new Date();
const tz = d=> new Date(d.getTime()-d.getTimezoneOffset()*60000);
const todayISO = tz(new Date()).toISOString().slice(0,10);
const wd = (new Date()).getDay(); // 0=Dim

if(!state.habits.length){
  state.habits = [
    {id:uid(), name:"Boire 500ml", type:"daily", slot:"morning", weekdays:[], color:COLORS[0], archived:false, objective:{mode:"perday",value:1}, created:todayISO},
    {id:uid(), name:"Course 20min", type:"weekly", slot:null, weekdays:[1,3,5], color:COLORS[1], archived:false, objective:{mode:"perweek",value:3}, created:todayISO},
    {id:uid(), name:"R√©gime 1800 kcal", type:"life", slot:null, weekdays:[], color:COLORS[2], archived:false, objective:{mode:"permonth",value:20}, created:todayISO}
  ];
  save();
}

/* ====== Render ====== */
const SECTIONS=[
  {id:'morning', label:'üåÖ Matin', filter:h=>h.type==='daily'&&h.slot==='morning'},
  {id:'day',     label:'üåû Journ√©e', filter:h=>h.type==='daily'&&h.slot==='day'},
  {id:'evening', label:'üåô Soir', filter:h=>h.type==='daily'&&h.slot==='evening'},
  {id:'weekly',  label:'üìÖ Hebdo du jour', filter:h=>h.type==='weekly'&&(h.weekdays||[]).includes(wd)},
  {id:'life',    label:'‚ù§Ô∏è Habitudes de vie', filter:h=>h.type==='life'}
];

function isDue(h,d){
  if(h.type==='daily' || h.type==='life') return true;
  if(h.type==='weekly') return (h.weekdays||[]).includes(d.getDay());
  return true;
}

function render(){
  const q = $("#search").value.trim().toLowerCase();
  const dueOnly = $("#dueBtn").classList.contains('active');
  const logs = state.logs || {};
  let due=0, done=0;

  const container = $("#sections"); container.innerHTML='';

  SECTIONS.forEach(sec=>{
    const items = state.habits.filter(h=>!h.archived && sec.filter(h) && (!q || h.name.toLowerCase().includes(q)) && (!dueOnly || isDue(h,new Date())));
    if(!items.length) return;

    const card = document.createElement('div'); card.className='card section';
    card.innerHTML = `<div class="section-title">${sec.label} <span class="badge" id="badge-${sec.id}"></span></div>`;
    const list = document.createElement('div');

    let sdue=0, sdone=0;
    items.forEach(h=>{
      const key = todayISO;
      const log = (logs[h.id] && logs[h.id][key]) || 0;  // nombre d√©j√† fait (supporte quantit√©)
      const target = Math.max(1, (h.objective && h.objective.mode==='perday') ? (h.objective.value||1) : 1);
      const reached = log >= target;
      if(isDue(h,new Date())) { sdue++; due++; if(reached) { sdone++; done++; } }

      const row = document.createElement('div'); row.className='habit'; row.style.background='transparent';
      row.innerHTML = `
        <div class="h-left">
          <div class="dot" style="background:${h.color}"></div>
          <div style="min-width:0">
            <div class="h-name">${h.name}</div>
            <div class="h-meta">${h.type}${h.type==='daily'&&h.slot? ' ¬∑ '+h.slot:''}${h.type==='weekly'?' ¬∑ '+(h.weekdays||[]).map(i=>['D','L','Ma','Me','J','V','S'][i]).join(''):''}
            ${h.objective? ' ¬∑ obj:'+ (h.objective.value||1) + (h.objective.mode==='perday'?'/j':h.objective.mode==='perweek'?'/sem':'/mois') : ''}</div>
          </div>
        </div>
        <div class="check" data-id="${h.id}">
          ${ (h.objective && h.objective.mode==='perday' && (h.objective.value||1)>1)
            ? `<div class="qty">
                 <button data-act="dec">‚àí</button>
                 <div>${log}/${target}</div>
                 <button data-act="inc">Ôºã</button>
               </div>`
            : `<button class="btnpill ${reached?'done':''}" data-act="toggle">${reached?'‚úì':''}</button>`
          }
        </div>
      `;
      // handlers
      const zone = row.querySelector('.check');
      zone.addEventListener('click',(e)=>{
        const id=h.id;
        const act = e.target.dataset.act || e.target.parentElement?.dataset?.act;
        if(!state.logs[id]) state.logs[id]={};
        const cur = state.logs[id][key]||0;
        if(act==='toggle'){
          state.logs[id][key] = cur>=target ? 0 : target; // coche pleine
        }else if(act==='inc'){
          state.logs[id][key] = Math.min((cur+1), 99);
        }else if(act==='dec'){
          state.logs[id][key] = Math.max((cur-1), 0);
        }
        if(state.logs[id][key]===0) delete state.logs[id][key];
        save(); render();
      });
      list.appendChild(row);
    });

    card.appendChild(list);
    container.appendChild(card);
    const b = card.querySelector(`#badge-${sec.id}`); b.textContent = `${sdone}/${sdue} faites`;
  });

  // progression globale
  const p = due? Math.round(done/due*100):0;
  $("#progress").style.width = p+"%";
  $("#progressMeta").textContent = `${done}/${due} faits (${p}%)`;
}

/* ====== Create modal ====== */
const sheet=$("#sheet"); const fab=$("#fab");
let selType='daily', selSlot='morning', selColor=state.settings.accent||'#48c78e';

fab.onclick=()=>sheet.classList.add('show');
$("#cancel").onclick=()=>sheet.classList.remove('show');

$$('.toggle [data-type]').forEach(b=>b.onclick=()=>{
  $$('.toggle [data-type]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); selType=b.dataset.type;
  $("#slotRow").classList.toggle('hidden', selType!=='daily');
  $("#weekRow").classList.toggle('hidden', selType!=='weekly');
});

$$('.toggle [data-slot]').forEach(b=>b.onclick=()=>{
  $$('.toggle [data-slot]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); selSlot=b.dataset.slot;
});

const pal=$("#palette"); pal.innerHTML='';
COLORS.forEach(c=>{ const s=document.createElement('button'); s.className='swatch'; s.style.background=c; s.onclick=()=>{ selColor=c; state.settings.accent=c; save(); applyTheme(); highlight(); }; pal.appendChild(s); });
function highlight(){ $$('.swatch').forEach(b=> b.style.outline = (b.style.background===selColor)?'3px solid rgba(255,255,255,.2)':'none'); }
highlight();

$("#save").onclick=()=>{
  const name=$("#hName").value.trim(); if(!name){ alert("Nom requis"); return; }
  const mode=$("#objMode").value; const val=Math.max(1, Number($("#objVal").value)||1);
  const weekdays = Array.from(document.querySelectorAll('#weekRow [type=checkbox]')).filter(i=>i.checked).map(i=>Number(i.dataset.d));
  const h = {
    id:uid(), name, type: selType, slot: selType==='daily'?selSlot:null,
    weekdays: selType==='weekly'?weekdays:[],
    color: selColor, archived:false, objective:{mode, value:val}, created: todayISO
  };
  state.habits.push(h); state.logs[h.id]=state.logs[h.id]||{};
  save(); $("#hName").value=''; sheet.classList.remove('show'); render();
};

/* ====== Search / Due / Theme ====== */
$("#search").oninput=render;
$("#dueBtn").onclick=()=>{ $("#dueBtn").classList.toggle('active'); render(); }
$("#themeBtn").onclick=()=>{
  const curr=state.settings.theme||'auto';
  state.settings.theme = curr==='dark'?'light':(curr==='light'?'auto':'dark');
  save(); applyTheme();
};

/* init */
render();
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
</script>
</body>
</html>
